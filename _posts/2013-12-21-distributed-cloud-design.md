---
layout: post
title:  "AWS에서 분산 시스템 구상하기"
date:   2013-12-21 23:55:55
categories: k
permalink: /distributed-cloud-design
---


얼마전부터 청소년 투표권 연령 인하를 위해 [사이트](http://1618vote.net)를 기획하면서 이벤트성 사이트에서 
어떤방법으로 손쉽게 스케일링(Scaling; 시스템을 분산해서 대규모 트래픽을 처리하는것)을 할수있는지 고민하던차에 
몇가지 방법을 정리해본다.

**다이렉트 호스팅**

AWS의 `정적` 파일 호스팅 서비스인 Simple Storage Service(이하 S3)에서 폼을 포함한 HTML파일을 호스팅하고 
그것의 응답한것을 EC2에서 PHP를 처리하고 RDS로 데이터베이스를 구성한다.

여기서 중요한것은 [s3fs](https://code.google.com/p/s3fs/)라는 것으로 EC2에서 S3의 버킷을 EC2 디렉토리에 마운트할수 있다. 

사실 설문조사를 할경우 순수 HTML로만 폼을 만들고 그것을 `action`을 통해서 원하는 위치의 스크립트로 쏴주기만하면 되니 
간단한 편이다.

우리는 한 머신에 설치되어 있는 LAMP에 익숙하다. 리눅스를 기반으로 Apache나 nginx웹서버에 PHP를 올려서 쓴다. 하지만 이벤트성 사이트에서는 
철저한 분리를 통해, 같은 양의 하드웨어로 더욱 많은 성능을 낼수있다.

**부하분산**

**웹서버와 애플리케이션서버 부하분산**

만약 하나의 머신이 감당할 수 있는 최대의 요청을 넘어서는 수준의 트래픽을 처리하려면 어떻게 해야 될까? 
나도 항상 궁금했는데, AWS상에서는 Elastic Load Balancing(이하 ELB)을 통해서 여러대의 EC2머신으로 분산을 시키면 된다. 

ELB의 원리, 더 크게 보아서 로드 밸런싱의 원리는 간단하다. 요청 a, b, c, d가 동시에 들어온다면 그 아래있는 웹서버 
1, 2, 3, 4로 날려준다. 그러면 전체적으로보면 꽤 만은 요청이지만 머신 한개당 처리할 요청은 그리 많지 않으므로, 궁극적으로 분산시스템을 만들 수 있다.

**데이터 베이스 부하분산**

데이터베이스의 경우 쓰기에 소모되는 CPU부하가 읽기보다 휠씬 많다는것을 알 수있다. case by case로 알아보자.

*-카카오톡 Sharding*

폐쇠적인 구조로 쓰기가 상당히 많은 편이다. 채팅방에 있는 소수의 사람들에게만 내용이 보이기때문에 쓰기에 초점을둔 
Sharding(이하 샤딩)이란 기법을 사용해야된다. 예를들어보면, 데이터베이스 a, b, c, b가 있다고 생각하자. 만약 
당신이 카톡 메시지 1, 2, 3, 4를 보낸다면 통상적인 시스템에서는 하나의 데이터베이스에 row 4개가 만들어지면서, 각각 시간과 유저의 고유 id로 구분된다. 샤딩을 하면 a, b, c, d에 row가 하나씩만 만들어지면서 각각 분산적으로 저장된다.

이런 복잡함?에도 샤딩을 하는 이유는 데이터배이스 특성 자체가 쓰기에 상당히 많은 부하가 걸린다는 것이다. 
읽기일경우 시간차이가 걸리더라도 다른 데이터베이스로 서서히 복제하여서 읽기의 부하를 줄이면 되지만 쓰기의 경우 그러한 딜레이에 치명적이기 때문에 샤딩을 사용한다.

*-트위터 Read Replica*

트위터를 생각해보면, 나의 계정 [@openhiun](https://twitter.com/i/discover)에는 80명의 팔로워가 있는데, 내가 글을 한번 쓰면 80명에게로 전달된다. 마찬가지원리로 [@BarackObama](https://twitter.com/BarackObama)가 글을 쓴다면 4000만명에게 전달된다. 단수한 계산으로만 해도 쓰기와 읽기가 수십에서 수천만배 차이가난다.(물론 쓰기가 더 많은 부하가 걸리지만, 
수많은 읽기에는 비교되지 못한다.) 이경우에는 DB를 복제하는 Read Republica를 사용해서 읽기의 많은 요청의 응답하면 된다.

-Replication 그리고 Availability Zone

Replication은 하드, 소프트웨어적인 공격을 웹서버나 데이터센터가 받을경우를 대비해 물리적으로 다른 장소에 DB를 저장한다는 뜻이다. 그 다른 장소는 Availability Zone이 될 수 있다.


**정적 콘텐츠 배포**

이미지나 CSS, JS는 사실 분산하면 할수록 좋다. **각각 파트가 제역할만 하면 할수록 시스템은 더 큰 부하를 견딜수 있다.** 심지어 애플리케이션과 밀접한 관련도 있는 HTML파일조차 위에서 본것처럼 분산하는 시대이다. S3에 파일을 저장한다면,
알아서 분산이 된다. 요청만큼 파일이 분산이되어서 확실하게 전달된다. 그러니 정적파일은 S3에 저장한다면 별다른 설정없이 배포 가능하다.

**결론**

항상 구글, 페이스북과 같은 시스템은 어떻게 돌아갈까 궁금한적이 있다.(지금도 여전히.) 그러나 이런방식이라는걸 알게되어서 대강 감은 온다. 이렇게 **웹, 애플리케이션 서버, 데이터베이스, 정적 컨텐츠**각 분야에 대해 대강 분산되는 방식을 알아보았다. 
